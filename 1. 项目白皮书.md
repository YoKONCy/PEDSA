# PEDSA RAG-less 算法白皮书

## 参考理论：脑科学与认知科学背景 (Theoretical Background)

PEDSA 的底层架构深度借鉴了现有的类脑记忆提取与情感认知的一系列成熟理论：

1.  **激活扩散模型 (Spreading Activation Model)**：
    *   **核心思想**：记忆是以语义网络的形式存储的，当一个概念（节点）被激活时，能量会沿关联路径向四周扩散。
    *   **PEDSA 实现**：通过 `Graph Diffusion` 机制，将本体层（Ontology）的关键词能量扩散至具体的记忆节点（Event），实现语义的联想式检索。

2.  **艾宾浩斯遗忘曲线 (Ebbinghaus Forgetting Curve)**：
    *   **核心思想**：人类记忆的留存程度随时间推移呈指数级衰减。
    *   **PEDSA 实现**：引入 `Ebbinghaus Decay` 能量补偿公式，利用 `tau` 半衰期动态计算记忆节点的残余能量，确保近期记忆在检索中具备天然的权重优势。

3.  **普拉切克情感轮 (Plutchik's Wheel of Emotions)**：
    *   **核心思想**：人类情感由 8 种基本情绪及其混合组成，情感是记忆的重要索引维度。
    *   **PEDSA 实现**：SimHash 指纹中预留了 `MASK_AFFECTIVE`（情感掩码）位，通过位运算模拟不同情感色彩的共鸣（Affective Resonance），让检索结果更具“共情”能力。

4.  **混沌情感理论 (Chaos Theory of Emotion)**：
    *   **核心思想**：情感系统是一个非线性的动力系统，微小的扰动可能导致状态的巨大跃迁（混沌共振）。
    *   **PEDSA 实现**：引入 `Chaos Level` 双轨机制。当理性检索（Rational Track）无法给出确定答案时，通过 `Chaotic Track`（两段式向量检索）模拟思维的“跳跃”与“灵感”，通过能量跃迁唤醒潜在的深层关联。

5.  **侧向抑制与反向抑制 (Lateral & Inverse Inhibition)**：
    *   **核心思想**：在神经系统中，活跃的神经元会抑制周围神经元的活动（侧向抑制），以增强信号的对比度和清晰度；同时对高频出现的通用背景信号进行抑制（反向抑制）。
    *   **PEDSA 实现**：
        *   **侧向抑制**：在扩散过程中通过 `layer_limit` 截断，仅保留能量最强的 Top-K 节点作为扩散种子，抑制弱噪声信号的蔓延。
        *   **反向抑制**：引入 `In-degree Penalty`（入度惩罚），对于连接数过多的“通用概念”（如“东西”、“事情”），通过入度对数衰减降低其扩散能量，防止其在检索中产生无意义的泛化。

---

## 1. 千万级压力测试表现 (Extreme Stress Test - V3)

在 V3 架构实现“索引-载体分离 (Index-Carrier Split)”后，我们针对 **1000 万级** 节点的实时检索场景进行了全新评估。

| 指标 | V3.5 (Chaos Optimized) | 备注 |
| **总节点数** | 10,000,000+ | 包含磁盘数据与热插入缓冲区 |
| **内存占用** | **~380 MB** | 增加 Chaos SoA 存储空间 |
| **单次全量扫描耗时** | **132 ms (Chaos + SIMD)** | 混沌检索全量扫描 |
| **混沌检索加速比** | **132 ms (Two-stage)** | **2.2x 性能提升** |
| **热插入支持** | **支持** | 无需重启即可实现增量更新 |

---

## 2. V3 架构演进：索引-载体分离与硬件加速

PEDSA V3 是一次彻底的底层重构，从传统的“内存对象树”转向了“面向硬件优化”的工业级架构：

### A. 索引-载体分离 (Index-Carrier Split - SoA)
*   **Hot Index (热索引)**：将所有节点的 SimHash 指纹、ID 和元数据提取出来，以 **Struct of Arrays (SoA)** 布局存储。
*   **Chaos Store (混沌存储)**：在 V3.5 中，混沌指纹 (512-bit) 与混沌向量 (512-dim f16) 也被重构为 SoA 布局。通过将 `fingerprints` 和 `vectors` 在内存中连续存放，显著提升了线性扫描时的缓存局部性。

### B. 内存映射与零拷贝 (Zero-copy mmap)
*   利用操作系统层面的 `mmap` 机制，将 10M 节点的索引文件映射到地址空间。
*   **冷启动消除**：程序启动时无需进行任何反序列化，加载时间从数十秒降至微秒级。

### C. SIMD 指纹扫描 (AVX2 Accelerated)
*   使用 **AVX2 (Advanced Vector Extensions)** 指令集，每次循环同时比对 4 个 64 位多模态指纹。
*   在 1000 万节点规模下，全量指纹 XOR 距离计算仅需约 7ms，彻底解决了大规模 RAG-less 检索的算力瓶颈。

### D. LSM-tree 思想的热插入缓冲区
*   引入 **Memory Buffer**，新产生的记忆节点先写入热缓冲区，检索时采用“磁盘(SIMD) + 缓冲区”的混合扫描逻辑，确保了记忆的实时性。

### E. 时空架构演进：从“硬编码”到“语义解析”
*   **空间降维**：V3 彻底移除了 SimHash 中难以维护的空间 (Location) 哈希维度。地理位置信息现在完全通过 **Ontology (本体层)** 的双向语义匹配实现（如：识别“深圳”直接激活关联事件），这比不精确的空间哈希更加可靠。
*   **纯时间区 (Temporal Only)**：SimHash 指纹中的 [32-47] 位现在专职于时间戳哈希。
*   **智能时间解析 (Temporal Intelligence)**：
    *   **相对时间解析**：引擎支持将“今天”、“昨天”、“刚才”、“上周”等自然语言描述，基于传入的参考时间 (`ref_time`) 动态转换为 Unix 时间戳，实现精准的“时间共振”。
    *   **AIPR 历法兼容**：针对 AI 所在的叙事时间线（如 2026 年）进行了提示词与逻辑优化，确保系统能正确区分“现实时间”与“故事时间”。
    *   **时序脊梁 (Temporal Backbone)**：通过 `prev_event` / `next_event` 物理链表将离散的记忆节点串联为线性的时序链条，支持记忆的“因果追溯”。

### F. 两段式混沌检索 (Two-stage Chaos Retrieval)
针对千万级规模下的“混沌共振”，V3.5 引入了高效的两段式过滤机制：
1.  **粗排 (Coarse Rank - 1-bit Quantization)**：利用 512-bit 混沌指纹（1-bit 量化后的特征）进行 Hamming 距离计算（XOR + popcount）。在 10M 规模下，初步筛选出距离 < 256 的候选节点。
2.  **精排 (Fine Rank - f16 Cosine Similarity)**：对候选节点进行 512 维 f16 向量的余弦相似度精确计算。
3.  **约束机制 (Logic Constraints)**：
    *   **严格阈值**：相似度必须 **> 0.95** 才能触发共振，确保只有极度相关的记忆会被“唤醒”。
    *   **修正系数 (0.15)**：混沌能量仅作为“锦上添花”，其最大修正权重被严格限制在 0.15，防止混沌逻辑劫持主语义检索。
    *   **摘要向量化**：仅对 `summary` 进行向量化处理，在保证检索精度的同时，极大降低了存储开销。

---

## 3. 检索流转过程 (V3.5 Dual-Track Flow)

当用户输入文本时，V3.5 检索流转升级为**理性 (Rational) 与 混沌 (Chaotic) 双轨并行架构**：

1.  **特征提取与初步激活 (Initial Activation)**：
    *   **关键词匹配**：AC 自动机提取文本特征，激活本体库 (Ontology) 中的定义节点。
    *   **索引召回**：通过 `temporal_index` 和 `affective_index` 桶，基于 SimHash 掩码快速捞取具备时间/情感共性的候选节点。
2.  **理性轨道：多层图扩散 (Rational Track: Graph Diffusion)**：
    *   **本体扩散**：在定义库中进行语义扩展（如：识别“猫”激活“宠物”、“动物”等关联）。
    *   **记忆扩散**：将能量从特征锚点沿图边缘传递至具体的事件 (Event) 节点。
    *   **反向抑制 (Inverse Inhibition)**：引入入度惩罚，防止高频泛化词（如“技术”、“人类”）过度干扰检索结果。
    *   **侧向抑制 (Lateral Inhibition)**：在扩散前对种子节点进行 Top-K 截断（`layer_limit`），确保只有最强信号进入深层扩散，抑制背景噪音。
3.  **理性轨道：语义细化 (Rational Track: Refinement)**：
    *   **分区重排序**：对 Top 50 候选进行 SimHash 多模态修正，精确比对语义、时间、情感和实体类型。
    *   **记忆衰减**：应用艾宾浩斯曲线，根据 `timestamp` 进行能量损耗计算（最低保留 0.8 能量）。
4.  **混沌轨道：两段式向量检索 (Chaotic Track: Two-stage Vector Scan)**：
    *   **L1 粗排**：对全量 SoA 布局的 1-bit 混沌指纹进行 Hamming 距离扫描。
    *   **L2 精排**：对粗排 Top 5000 候选进行 128 维 f16 向量的余弦相似度计算。
    *   **激活约束**：仅当相似度 > 0.95 时触发能量跃迁。
5.  **双轨融合与时序增强 (Fusion & Boosting)**：
    *   **权重融合**：根据 `chaos_level` 参数动态混合理性得分与混沌得分。
    *   **时序脊梁补偿**：利用 `prev_event` / `next_event` 链表进行上下文能量补偿，输出最终 TOP 20。

---

## 4. 检索精度评估 (Precision@k Evaluation)

我们引入了标准的 `Precision@k` 指标，通过 15 个硬核 Ground Truth 查询对系统进行了精度评估：

*   **测试样本总数**: 15
*   **🎯 Top-1 命中率**: 100.00% (15/15)
*   **🎯 Top-5 命中率**: 100.00% (15/15)

**分析与优化历程**：
*   **初始瓶颈**：早期测试发现 Top-1 命中率为 80%，部分旧记忆被过于激进的艾宾浩斯衰减（50% 能量损失）所掩盖。
*   **优化方案**：
    1.  **延长半衰期**：将 `tau` 从 180 天延长至 365 天。
    2.  **设置能量地板**：将衰减系数的最低限值从 0.5 提升至 0.8，确保旧记忆最多只损失 20% 的能量。
    3.  **权重重平衡**：显著提升了 SimHash 语义共振的权重（0.3 -> 0.6），使其在能量扩散中占据主导地位。
*   **最终结果**：在不牺牲时间感的前提下，实现了技术检索的 100% 准确率。

---

## 5. 维护层与知识自愈设计 (Maintenance & Self-Healing)

为了实现图谱的自进化与逻辑一致性，我们设计了 **统一维护接口 (Unified Maintenance Interface)** 与双层 LLM 协作机制：

### A. 统一维护流程 (Unified Flow)
*   **入口收敛**：通过 `execute_maintenance` 统一处理所有增量输入，支持 `upsert` (追加/更新) 与 `replace` (替换/重写) 两种逻辑动作。
*   **动作路由**：
    *   **Upsert**: 直接进行本体关联的建立或强度累加（记忆强化）。
    *   **Replace**: 针对“状态覆盖”场景（如：从“蓝发”变为“红发”）。系统先应用新关联，随后触发 **逻辑仲裁机制**。

### B. 逻辑仲裁机制 (Replace & Arbitration)
*   **1-hop 上下文提取**：当触发 `replace` 时，引擎自动提取主体（Subject）的 **1-hop 局部子图 (Ego-network)**，构建冲突现场上下文。
*   **仲裁者 (LLM2 Arbiter)**：将局部子图、新事实及变更理由发送给专门的仲裁提示词（详见 [PEDSA_ARBITER_PROMPT.md](./PEDSA_ARBITER_PROMPT.md)）。
*   **知识回删**：仲裁者识别出互斥的旧知识（如过时的属性）并返回删除指令，引擎通过 `apply_arbitration` 物理移除冲突边，实现知识自愈。

### C. 自动化剪枝与遗忘 (Pruning & Forgetting)
*   **噪声抑制**：引入 `prune_ontology` 机制，自动清理强度低于阈值 (0.1) 的虚假关联。
*   **容量保护**：每个节点限制最大关联数 (100)，通过按强度排序截断，模拟大脑对低价值信息的“物理遗忘”，确保大规模扩散时的计算效率。

### D. 维护层特性
*   **多模态对齐**：Prompt 强制约束输出 8 种情感与 6 种实体类型，确保生成的 JSON 与 Rust 引擎的 `SimHash` 掩码计算逻辑完全对齐。
*   **时序锚点**：强制 Summary 以“YYYY年MM月DD日”开头，适配引擎的 `extract_timestamp` 硬解析逻辑。
*   **职责解耦**：LLM 仅负责提取“原子化”关联，不参与底层千万级节点的遍历。

---

## 6. 测试场景覆盖 (Tests Summary)

目前已封装 15 个核心测试场景，确保逻辑稳健：
1.  **语义对齐**：佩罗 -> Pero。
2.  **长文本共振**：处理 100 字以上的复杂技术/生活描述。
3.  **碎片化输入**：关键词堆堆检索。
4.  **间接推理**：通过“蝴蝶结”定位到人物。
5.  **时间与地点回溯**：精确匹配特定年份、城市和事件（地点通过本体层召回）。
6.  **时序追溯**：利用 Temporal Backbone 进行“后续事件”查找。
7.  **情感共鸣**：区分喜悦、愤怒、害羞等不同情感底色的记忆。
8.  **记忆衰减**：模拟艾宾浩斯曲线，优先召回近期记忆。
9.  **相对时间解析**：测试“刚才”、“昨天”、“去年”等词汇在不同 `ref_time` 下的召回准确度。
10. **知识仲裁 (Logic Arbitration)**：模拟属性冲突（蓝发 -> 红发），验证 Replace 动作。
11. **自动化剪枝 (Auto Pruning)**：验证低强度噪声清理。

---

## 7. 注记

*   “如无必要，勿增实体；少即是好，易即是难”
*   这个项目本质上是一个 Graph 引擎。具体能检索到什么，完全取决于图构建得怎么样，所以几乎没什么通用性。不过，就我自用而言，单论在 AIRP 场景的记忆检索下，效果还挺不错的就是了。